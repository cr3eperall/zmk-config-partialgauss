/*
 * Copyright (c) 2025 cr3eperall
 *
 * SPDX-License-Identifier: MIT
 */

#include <dt-bindings/zmk/matrix_transform.h>
#include <dt-bindings/he/mouse_forwarder.h>
#include <dt-bindings/he/gamepad_forwarder.h>
#include <input/he_processors.dtsi>
#include <physical_layouts.dtsi>

&adc {
    status = "okay";

    #address-cells = <1>;
    #size-cells = <0>;
    // nrf52840/nano_33_ble adc pin assignments:
    // AIN2 = P0.04 (A0 in nano_33_ble)
    // AIN3 = P0.05 (A1 in nano_33_ble)
    // AIN6 = P0.30 (A2 in nano_33_ble)
    // AIN5 = P0.29 (A3 in nano_33_ble)
    // AIN7 = P0.31 (A4 in nano_33_ble)
    // AIN0 = P0.02 (A5 in nano_33_ble)
    // AIN4 = P0.28 (A6 in nano_33_ble)
    // AIN1 = P0.03 (A7 in nano_33_ble)
    channel@0 {
        reg = <0>;
        zephyr,input-positive = <NANO_33_BLE_A0>;
        zephyr,gain = "ADC_GAIN_1_2";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 10)>;
        zephyr,resolution = <12>;
    };
    channel@1 {
        reg = <1>;
        zephyr,input-positive = <NANO_33_BLE_A1>;
        zephyr,gain = "ADC_GAIN_1_2";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 10)>;
        zephyr,resolution = <12>;
    };
    channel@2 {
        reg = <2>;
        zephyr,input-positive = <NANO_33_BLE_A2>;
        zephyr,gain = "ADC_GAIN_1_2";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 10)>;
        zephyr,resolution = <12>;
    };
    channel@3 {
        reg = <3>;
        zephyr,input-positive = <NANO_33_BLE_A3>;
        zephyr,gain = "ADC_GAIN_1_2";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 10)>;
        zephyr,resolution = <12>;
    };
    channel@4 {
        reg = <4>;
        zephyr,input-positive = <NANO_33_BLE_A4>;
        zephyr,gain = "ADC_GAIN_1_2";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 10)>;
        zephyr,resolution = <12>;
    };
    channel@5 {
        reg = <5>;
        zephyr,input-positive = <NANO_33_BLE_A5>;
        zephyr,gain = "ADC_GAIN_1_2";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 10)>;
        zephyr,resolution = <12>;
    };
    // channel@6 {
    //     reg = <6>;
    //     zephyr,input-positive = <NRF_SAADC_VDDHDIV5>;
    //     zephyr,gain = "ADC_GAIN_1_2";
    //     zephyr,reference = "ADC_REF_INTERNAL";
    //     zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 40)>;
    //     zephyr,resolution = <12>;
    // };
};

&raw_sp {
    matrix-size = <2 3>;
    working-area = <250 3050>;
    // I lost so many hours debugging this with the wrong values, please check them carefully in the future
    filter-coefficients = <0x3ca485df 0x3d2485df 0x3ca485df 0x3f800000 0xbfc7cf71 0x3f242f9d>;
};

&he_trans {
    // log;
};
&he_pass {
    kscan-passthrough-position = <2700>;
    keymap-size = <12>;
};
&rt_pass{
    keymap-size = <12>;
};
&mouse_fw{
    time-to-max-speed-ms = <300>;
    working-area = <300 2800>;
    scale-x-float = <0x40400000>;/* 3.0 */
    scale-y-float = <0x40400000>;/* 3.0 */
    scale-h-wheel-float = <0x40400000>;/* 3.0 */
    scale-v-wheel-float = <0x40400000>;/* 3.0 */
};
// &uart0{
//     status="okay";
// };

/ {
    chosen {
        // zephyr,display = &oled;
        zmk,kscan = &kscan;
        zmk,physical-layout = &physical_layout0;
        // zmk,battery = &battery_ch;
        // zephyr,console = &uart0;
        // zephyr,console = &snippet_zmk_usb_logging_uart;
        // zephyr,shell-uart = &snippet_zmk_usb_logging_uart;
    };

    // On the nano 33 ble, the battery is connected to an on board regulator that goes to vdd, so the only way to measure the battery is with a voltage divider
    // but i don't have any free adc pins
    // 
    // battery_ch: battery_channel {
    //     compatible = "zmk,battery-nrf-vddh-channel";
    //     io-channels = <&adc 6>;
    // };
    
    physical_layout0: physical_layout_0 { // First physical layout, use different naming for other layouts
        compatible = "zmk,physical-layout";
        display-name = "Default Layout";
        kscan = <&kscan>; // Label of the kscan node, optional if all layouts use the same
        transform = <&default_transform>; // Label of the matrix transform for this layout
        keys  //                     w   h    x    y     rot    rx    ry
            = <&key_physical_attrs 100 100    0  121       0     0     0>
            , <&key_physical_attrs 100 100  100   68       0     0     0>
            , <&key_physical_attrs 100 100  200   26       0     0     0>
            , <&key_physical_attrs 100 100  301    0       0     0     0>
            , <&key_physical_attrs 100 100  401   32       0     0     0>
            , <&key_physical_attrs 100 100  501   58       0     0     0>
            , <&key_physical_attrs 100 100 1092   58       0     0     0>
            , <&key_physical_attrs 100 100 1192   32       0     0     0>
            , <&key_physical_attrs 100 100 1292    0       0     0     0>
            , <&key_physical_attrs 100 100 1392   26       0     0     0>
            , <&key_physical_attrs 100 100 1493   68       0     0     0>
            , <&key_physical_attrs 100 100 1593  121       0     0     0>
            , <&key_physical_attrs 100 100    0  221       0     0     0>
            , <&key_physical_attrs 100 100  100  169       0     0     0>
            , <&key_physical_attrs 100 100  200  127       0     0     0>
            , <&key_physical_attrs 100 100  301  100       0     0     0>
            , <&key_physical_attrs 100 100  401  132       0     0     0>
            , <&key_physical_attrs 100 100  501  158       0     0     0>
            , <&key_physical_attrs 100 100 1092  158       0     0     0>
            , <&key_physical_attrs 100 100 1192  132       0     0     0>
            , <&key_physical_attrs 100 100 1292  100       0     0     0>
            , <&key_physical_attrs 100 100 1392  127       0     0     0>
            , <&key_physical_attrs 100 100 1493  169       0     0     0>
            , <&key_physical_attrs 100 100 1593  221       0     0     0>
            , <&key_physical_attrs 100 100  100  269       0     0     0>
            , <&key_physical_attrs 100 100  200  227       0     0     0>
            , <&key_physical_attrs 100 100  301  200       0     0     0>
            , <&key_physical_attrs 100 100  401  232       0     0     0>
            , <&key_physical_attrs 100 100  501  258       0     0     0>
            , <&key_physical_attrs 100 100 1092  258       0     0     0>
            , <&key_physical_attrs 100 100 1192  232       0     0     0>
            , <&key_physical_attrs 100 100 1292  200       0     0     0>
            , <&key_physical_attrs 100 100 1392  227       0     0     0>
            , <&key_physical_attrs 100 100 1493  269       0     0     0>
            , <&key_physical_attrs  50 100  620  280       0     0     0>
            , <&key_physical_attrs  50 100  670  280       0     0     0>
            , <&key_physical_attrs 100 100  375  348       0     0     0>
            , <&key_physical_attrs 100 100  506  385    3000   556   435>
            , <&key_physical_attrs 100 100  593  435    3000   643   485>
            , <&key_physical_attrs 100 100 1000  435 (-3000)  1050   485>
            , <&key_physical_attrs 100 100 1087  385 (-3000)  1137   435>
            , <&key_physical_attrs 100 100 1218  348       0     0     0>
            , <&key_physical_attrs  50 100  970  280       0     0     0>
            , <&key_physical_attrs  50 100 1020  280       0     0     0>
            ;
    };


    default_transform: keymap_transform_0 {
        compatible = "zmk,matrix-transform";
        columns = <12>;
        rows = <4>;
// |  SW1  |  SW2  |  HE1  |  HE2  |  HE3  |  SW3  | |  SW3  |  HE3  |  HE2  |  HE1  |  SW2  |  SW1  |
// |  SW4  |  SW5  |  HE4  |  HE5  |  HE6  |  SW6  | |  SW6  |  HE6  |  HE5  |  HE4  |  SW5  |  SW4  |
//         |  SW7  |  SW8  |  SW9  | SW10  | SW11  | | SW11  | SW10  |  SW9  |  SW8  |  SW7  | 
//                         |  SW12 | SW13  | SW14  | | SW14  | SW13  | SW12  |
        map = <
    RC(0,0) RC(0,1) RC(3,0) RC(3,1) RC(3,2) RC(0,4)   RC(0,5) RC(3,5) RC(3,6) RC(3,7) RC(0,8) RC(0,9)
    RC(1,0) RC(1,1) RC(4,0) RC(4,1) RC(4,2) RC(1,4)   RC(1,5) RC(4,5) RC(4,6) RC(4,7) RC(1,8) RC(1,9)
            RC(2,1) RC(0,2) RC(0,3) RC(1,3) RC(2,4)   RC(2,5) RC(1,6) RC(0,6) RC(0,7) RC(2,8)
    RC(3,3) RC(3,4)         RC(1,2) RC(2,2) RC(2,3)   RC(2,6) RC(2,7) RC(1,7)         RC(3,8)  RC(3,9)
        >;
    };

    kscan_gpio: kscan-gpio {
        compatible = "zmk,kscan-gpio-matrix";
        wakeup-source;

        diode-direction = "col2row";
        row-gpios
            = <&nano_33_ble 12 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&nano_33_ble 11 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&nano_33_ble 10 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            ;

    };

    kscan: kscan0 {
        compatible = "zmk,kscan-composite";
        wakeup-source;
        rows = <4>;
        columns = <12>;
        gpio-matrix {
            kscan = <&kscan_gpio>;
            row-offset = <0>;
            col-offset = <0>;
        };
        adc-direct {
            kscan = <&kscan_adc>;
            row-offset = <3>;
            col-offset = <0>;
        };
        select-switches {
            kscan = <&kscan_selector>;
            row-offset = <3>;
            col-offset = <3>;
        };
    };

    pulse_set_forwarder: pulse-set-forwarder {
        compatible = "he,pulse-set-forwarder";
    };

    kscan_adc: kscan-adc {
        compatible = "he,kscan-direct-pulsed";
        resolution = <12>;
        pulse-read;
        // calibrate;
        read-turn-on-time= <50>;
        wait-period-idle= <5>;
        wait-period-press= <1>;
        kscan-forwarder = <&kscan_forwarder>;
        pulse-set-forwarder= <&pulse_set_forwarder>;
        kscan_adc_top: top {
            enable-gpios= <&nano_33_ble_gpio_a 6 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
            // switch-pressed-is-higher;
            switch-height = <3300>;
        };
        kscan_adc_bot: bot {
            enable-gpios= <&nano_33_ble_gpio_a 7 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
            // switch-pressed-is-higher;
            switch-height = <3300>;
        };
    };
    kscan_selector: kscan-selector {
        compatible = "zmk,kscan-gpio-direct"; //TODO implement custom driver with pull_up toggling
        // wakeup-source;
    };

    socd_d: he-socd1{
        compatible = "he,input-processor-socd";
        #input-processor-cells = <1>;
        sensitivity = <250>;
        kscan-forwarder = <&kscan_forwarder>;
        kscan-passthrough;
        actuation-point = <2800>;
        type= "priority_deeper";
    };

    ps: he_set_p{ //name needs to be <= 8 chars
        compatible = "he,behavior-pulse-set";
        #binding-cells = <1>;
        pulse-set-forwarder = <&pulse_set_forwarder>;
    };

    he_transform: he_transform {// mapping of he sensors before going to kscan-composite but with he,input-processor-matrix-offset applied
        compatible = "zmk,matrix-transform";
        // status= "disabled";
        columns = <8>;
        rows = <2>;
        // |  HE1  |  HE2  |  HE3  |  |  HE3  |  HE2  |  HE1  |
        // |  HE4  |  HE5  |  HE6  |  |  HE6  |  HE5  |  HE4  |
        map = <
            RC(0,0) RC(0,1) RC(0,2)    RC(0,5) RC(0,6) RC(0,7)
            RC(1,0) RC(1,1) RC(1,2)    RC(1,5) RC(1,6) RC(1,7)
        >;
    };

    he_keymap: he-keymap {
        compatible = "he,input-processor-keymap";
        status= "disabled";
        #input-processor-cells = <1>;
        transform = <&he_transform>;
    };
    
    split_inputs: split_inputs {
        #address-cells = <1>;
        #size-cells = <0>;
        input_split: input_split@0 {
            compatible = "zmk,input-split";
            reg = <0>;
        };
    };

    central_listener: central_listener {
        compatible = "he,input-listener";
        status = "disabled";
        device = <&kscan_adc>;
        input-processors = <&raw_sp>;
        layer8 {
            layers = <8>;
            input-processors = <&he_keymap 8>;
        };
        layer7 {
            layers = <7>;
            input-processors = <&he_keymap 7>;
        };
        layer6 {
            layers = <6>;
            input-processors = <&he_keymap 6>;
        };
        layer5 {
            layers = <5>;
            input-processors = <&he_keymap 5>;
        };
        layer4 {
            layers = <4>;
            input-processors = <&he_keymap 4>;
        };
        layer3 {
            layers = <3>;
            input-processors = <&he_keymap 3>;
        };
        layer2 {
            layers = <2>;
            input-processors = <&he_keymap 2>;
        };
        layer1 {
            layers = <1>;
            input-processors = <&he_keymap 1>;
        };
        layer0 {
            layers = <0>;
            input-processors = <&he_keymap 0>;
        };
    };
    peripheral_listener: peripheral_listener {
        compatible = "he,input-listener";
        status = "disabled";
        device = <&input_split>;
        layer8 {
            layers = <8>;
            input-processors = <&he_keymap 8>;
        };
        layer7 {
            layers = <7>;
            input-processors = <&he_keymap 7>;
        };
        layer6 {
            layers = <6>;
            input-processors = <&he_keymap 6>;
        };
        layer5 {
            layers = <5>;
            input-processors = <&he_keymap 5>;
        };
        layer4 {
            layers = <4>;
            input-processors = <&he_keymap 4>;
        };
        layer3 {
            layers = <3>;
            input-processors = <&he_keymap 3>;
        };
        layer2 {
            layers = <2>;
            input-processors = <&he_keymap 2>;
        };
        layer1 {
            layers = <1>;
            input-processors = <&he_keymap 1>;
        };
        layer0 {
            layers = <0>;
            input-processors = <&he_keymap 0>;
        };
    };
    mouse_fw_listener: mouse_fw_listener {
        compatible = "he,input-listener";
        status = "disabled";
        device = <&mouse_fw>;
    };
        
};

// &nano_33_ble_i2c {
//     status = "okay";

//     oled: ssd1306@3c {
//         compatible = "solomon,ssd1306fb";
//         reg = <0x3c>;
//         width = <128>;
//         height = <32>;
//         segment-offset = <0>;
//         page-offset = <0>;
//         display-offset = <0>;
//         multiplex-ratio = <31>;
//         segment-remap;
//         com-invdir;
//         com-sequential;
//         inversion-on;
//         prechargep = <0x22>;
//     };
// };